---
title: "Week 3 Discussion Question Solution"
author: "UNSW Business School, ACTL3182"
date: "September 2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
\section{1. Feedback}
This question was generally very well done with the majority of students choosing to use
excel or R. It was good to see the high quality of presentation of your solutions. Note that this solution performs the optimisation manually using the quadprog package and the methods in the lecture slides. However, you are free to use the IntroCompFin package instead (and likewise in the assignment). Some specifics are given below:
\subsection{Done well}
* Questions generally answered correctly
* Solutions were presented very nicely
* Good initiative to learn the required packages for those that used R

\subsection{Some Mistakes}
* Forgetting to plot securities, the GMVP or the tangency portfolio.
* The efficient frontier when a risk-free asset is available should end at the intercept $(0, 0.04)$ corresponding to the risk-free rate.
There should not be another branch below this point.
* Trying to find the market portfolio to obtain the efficient frontier with a risk-free asset. This is not needed, and we would need an equilibrium assumption.

\subsection{Concept Tips}
* For the first two parts, there is no need to do optimisation to calculate the variance. Simply use the closed-form expressions derived in the slides. 
* Instead of using a sequence of weights and then calculating mean/variance through $\mathbf{z}^{\top}\mathbf{w}$ and $\mathbf{w}^{\top}\Sigma\mathbf{w}$, use the direct relation 
given in the annotated slides of Module 1 pg 61 (see solution part of this file).
* The equation of a line is uniquely defined by two points. Hence, you only need to generate
two points to plot the efficient frontier when the risk-free is available.

\subsection{Software Tips}
* [R] Assign commonly used quantities such as $\Sigma^{-1}$ to variables rather than writing $\texttt{solve(Sigma)}$ multiple times
* [R] For loops can usually be replaced with more efficient vectorised operations
* [R] R functions automatically return the last quantity calculated so there is usually no need
to have a return statement.
* [Excel] When doing your assignment, border your cells for more readibility.
* [Excel] If you wish to automate solver through VBA, first go to Developer$\to$Visual Basic$\to$Tools$\to$References and make sure solver is ticked.

\newpage

\section{2. Question Solution}
\subsection{Risky assets only}
Enter the relevant data.
```{r}
#Mean, sandard deviation and correlation coefficient
z <- c(0.1, 0.08, 0.12, 0.14, 0.06, 0.09, 0.05, 0.08, 0.1, 0.12)
sd <- c(0.05, 0.06, 0.04, 0.07, 0.02, 0.03, 0.01, 0.04, 0.04, 0.02)
rho <- 0.5  
n_stocks <- length(z)
stocks_df <- data.frame(z, sd)
```
We compute the covariance matrix and relevant portfolio constants. The covariance matrix can be efficiently calculated with a vector outer product since the correlation is constant. A double for loop is not required.

```{r}
#Covariance matrix
Sigma <- sd %*% t(sd) * rho 
diag(Sigma) <- sd^2

#Compute Constants
Sigma_Inv <- solve(Sigma)
ones <- matrix(rep(1, n_stocks), nrow = n_stocks)

#Helper function to calculate quadratic forms x^T A y
quad_form <- function(x, A, y = x) {
  as.numeric(t(x) %*% A %*% y)
}

A <- quad_form(ones, Sigma_Inv)
B <- quad_form(z, Sigma_Inv, ones)
C <- quad_form(z, Sigma_Inv)
Delta <- A*C - B^2
```
The efficient frontier can easily be computed using the following formula for $\sigma_{P}^{2}$, which can be found on the annotated slides of Module 1 page 61. 
$$\sigma_{P}^{2}=\frac{A\mu^{2}_{P} - 2B\mu_{P} + C}{\Delta}$$
There is no need to calculate weights,
Lagrange multipliers, or perform quadratic optimisation when you have an closed-form 
expression.
```{r}
#Function to calculate portfolio standard deviation, only risk assets.
sd_P <- function(mu, A, B, C, Delta) {
  sqrt((A*mu^2 - 2*B*mu + C) / Delta)
}
increment <- 1e-4
mu_P <- seq(from = 0, to = 0.2, by = increment)
sd_P <- sd_P(mu_P, A, B, C, Delta)
risky_frontier <- data.frame(sd_P, mu_P)
```
Recall from the slides and tutorial question 1.38 that the mean and variance of the 
Global minimum variance portfolio are given by $(B/A, 1/A)$.
```{r}
mu_g <- B/A
sd_g <- sqrt(1/A)
GMVP <- data.frame(mu_g, sd_g)
```

\subsection{With risk-free}
It is sufficient to draw a line through the two points
$(0, 0.04)$ (risk-free rate) and $(\sigma_{\mu=0.2}, 0.2)$ (upper limit). We also need the tangency portfolio $(\sigma_{t}, \mu_{t})$, which can be derived by substituting the expression
$$\mathbf{w}_{t} = \frac{1}{B - Ar_{f}}\Sigma^{-1}(\mathbf{z} - r_{f}\mathbf{1})$$
into the equations
$$\mu_{t} = \mathbf{z}^{\top}\mathbf{w}_{t},\qquad \sigma_{t}^{2} = \mathbf{w}^{\top}_{t}\Sigma\mathbf{w}_{t}.$$
```{r}
#Compute Tangency portfolio 
rf <- 0.04
mu_t <- (C - B*rf) / (B - A*rf)
sd_t <- sqrt(C - 2*B*rf + A*rf^2)/ (B - A*rf)
tangency_portfolio <- data.frame(mu_t, sd_t)

#Points for risk-free frontier
mu_max = 0.2
sd_max = (mu_max - rf) / sqrt(C - 2*B*rf + A*rf^2)
risk_free_frontier <- data.frame(sd_rf = c(0, sd_t, sd_max), 
                                 mu_rf = c(rf, mu_t, mu_max))
```
\subsection{No short selling}
When short selling is not allowed, each weight must be non-negative. Thus, the standard
Lagrange multipliers method cannot be applied here. Instead, this is a
quadratic programming problem that can be solved with the quadprog package, which optimises functions of the form
$$f(\mathbf{x}) = \frac{1}{2}\mathbf{x}^{\top}D\mathbf{x} -\mathbf{d}^{\top}\mathbf{x} \qquad\text{with respect to}\quad A^{\top}\mathbf{x} \geq \mathbf{b}.$$
```{r}
library(quadprog)
constraint_matrix <- cbind(z, ones, diag(n_stocks))
mu_no_short <- seq(0.05, 0.14, increment/2)

#Helper function to perform optimisation and find standard deviation given mean
#More information on how to impose constraints can be found in the help section.
sigma_no_short <- function(mu, constraint_matrix, Sigma, n_stocks) {
  MV_no_short <- solve.QP(
    Dmat = 2*Sigma,
    dvec = rep(0, n_stocks),
    Amat = constraint_matrix,
    bvec = c(mu, 1, rep(0, n_stocks)),
    meq = 2
  )
  sqrt(MV_no_short$value)  
}

#Convert mu to 1 by n matrix and use apply function to optimize for all mu values
sd_no_short <- apply(matrix(mu_no_short, nrow = 1), 
                     MARGIN = 2,
                     FUN = function(x) 
                      sigma_no_short(x, constraint_matrix, Sigma, n_stocks))

no_short_frontier <- data.frame(sd_no_short, mu_no_short)
```

Combine all parts and plot.
```{r}
#Note one should not suppress warnings in general. It is done here to
#remove the warning message for being built under an older version of R.
suppressWarnings(library(ggplot2))
suppressWarnings(library(ggrepel))

final_plot <- ggplot() +
  #Part a) risky only
  geom_point(data = risky_frontier, aes(sd_P, mu_P, colour = "Risky only"), 
             size = 1, shape = 20) +
  geom_point(data = GMVP, aes(sd_g, mu_g), size = 4, colour = "red1", alpha = 0.7) +
  #Part b) risk-free
  geom_point(data = tangency_portfolio, 
             aes(sd_t, mu_t), size = 4, alpha = 0.7, colour = "green4") + 
  geom_line(data = risk_free_frontier, 
            aes(sd_rf, mu_rf, colour = "With Risk Free"),
            size = 1, alpha = 0.7) + 
  #Part c) no shorting
  geom_point(data = no_short_frontier, 
             aes(sd_no_short, mu_no_short, colour = "No short selling"),
             size = 1, shape = 20) +
  #Securities
  geom_point(data = stocks_df, aes(sd, z, colour = "Securities"), 
             size = 3) +
  #Axes
  labs(
    x = "Standard Deviation",
    y = "Mean Return",
    title = "Return vs Risk plot"
  ) +
  scale_x_continuous(breaks = 0.01 * 0:7) + 
  scale_y_continuous(breaks = 0.04 * 0:5) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5)) +
  #Labels
  geom_label_repel(aes(sd_g, mu_g), GMVP, 
                   nudge_x = -0.02, nudge_y = -0.03, 
                   label = "Global Minimum Variance Portfolio") +
  geom_label_repel(aes(sd_t, mu_t), tangency_portfolio, 
                   nudge_x = -0.015, nudge_y = 0.02, 
                   label = "Tangency Portfolio") + 
  scale_colour_manual(
    "",
    values = c(
      "Securities" = "gold1",
      "Risky only" = "black",
      "With Risk Free" = "blue",
      "No short selling" = "red"
    ),
    breaks = c("Securities", "Risky only", "With Risk Free", "No short selling")
  ) + 
  theme(legend.position="bottom")
final_plot
```